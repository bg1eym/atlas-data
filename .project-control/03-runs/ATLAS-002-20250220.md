# Run Journal — ATLAS-002 (PCK-ATLAS-002)

**Task:** Evidence-based activation audit — why TG behavior didn't change despite gates passing

**Timestamp:** 2025-02-20

---

## 1. What We Observed

- TG replies unchanged after PCK-ATLAS-001: help text, /atlas today behavior
- Gates (preflight, regress, convergence) all passed
- No way to verify which code the running gateway was actually using

---

## 2. What Audit Script Proved

Running `tools/atlas-activation-audit.sh`:

```
TG bot is using code from: /Users/qiangguo/Projects/vibe-template/projects/oc-personal-agent-lab/oc-bind
That code HEAD is: 4359a0d692d65e29fd77a9faa573fd8165c823a1
Help text originates from: .../oc-bind/index.ts:36:const ATLAS_HELP_TEXT = ...
```

- Loaded plugin dir: from `~/.openclaw/openclaw.json` plugins.load.paths[0]
- Gateway process: node on port 18789
- Forbidden radar strings: none found in plugin dir

---

## 3. Why Gates Passed But Runtime Unchanged (Root Cause)

**Hypothesis:** Deployment/activation mismatch — code was changed in workspace but:
- Gateway may have been started before changes, using cached/old module
- Or gateway loads from a different path than the one we edited
- No build fingerprint meant we could not verify which code version was active

**Guardrails added:** Build fingerprint in every /atlas reply allows instant human verification. After gateway restart, `/atlas help` will show `build: <sha> <ledger> <plugin_basename>` — if sha matches expected git HEAD, the correct code is loaded.

---

## 4. Guardrails Added

| Item | Purpose |
|------|---------|
| Build fingerprint | Suffix on all /atlas replies: `build: <sha> <ledger> <basename>` |
| /atlas debug | Returns fingerprint, plugin dir basename, env presence (ATLAS_ROOT, etc.) |
| tools/atlas-activation-audit.sh | Deterministic audit: gateway process, loaded plugin, help source, forbidden strings |
| RG-ATLAS-002 | Asserts fingerprint in code + unit test for format |
| build-fingerprint-test.ts | Unit test: getBuildFingerprint() returns valid format |

---

## 5. Commands Executed + Raw Outputs

### Pre-change (Phase 0)

```bash
$ bash .project-control/04-gates/preflight.sh
=== Preflight PASS ===
Latest ledger: PCK-BOOTSTRAP-000

$ bash .project-control/04-gates/regress.sh
RG-001 PASS: Version/identity evidence found in runtime
RG-ATLAS-001 PASS: No forbidden radar strings
=== Regress PASS ===
```

### Post-change

```bash
$ bash .project-control/04-gates/regress.sh
RG-001 PASS: Version/identity evidence found in runtime
RG-ATLAS-001 PASS: No forbidden radar strings
RG-ATLAS-002: gateway logs exist but no fingerprint yet (invoke /atlas help to populate)
RG-ATLAS-002 PASS: build fingerprint format OK: build: 4359a0d PCK-ATLAS-002 oc-bind
RG-ATLAS-002 PASS: build fingerprint present and format valid
=== Regress PASS ===

$ bash .project-control/04-gates/convergence.sh
=== Convergence PASS (contract unchanged) ===
```

### Audit script

```bash
$ bash tools/atlas-activation-audit.sh
# (see Phase 2 output above)
=== Audit complete ===
```

---

## 6. Next Steps Recommendation

1. **Restart gateway** so it loads the new oc-bind code with build fingerprint
2. **Invoke `/atlas help`** in TG — verify reply contains `build: <sha> PCK-ATLAS-002 oc-bind`
3. **Compare sha** with `git -C <plugin_dir> rev-parse --short HEAD` — must match
4. If sha does not match: gateway is still running old code; restart required
5. **Invoke `/atlas debug`** — verify env presence flags (ATLAS_ROOT, etc.)

---

## Failure Classification

failure_mode: OK
root_cause: 
recommended_fix:
