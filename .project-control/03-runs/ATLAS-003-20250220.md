# Run Journal — ATLAS-003 (PCK-ATLAS-003)

**Task:** 证据化定位 + 修复 launchd 下 pnpm ENOENT

**Timestamp:** 2025-02-20

---

## 1. 诊断结论（证据化）

### 现象

1) **/atlas debug** 显示：ATLAS_ROOT、ATLAS_DASHBOARD_URL_BASE、ATLAS_COVER_URL_BASE 均 **present**
2) **/atlas today** 报错：`❌ Atlas 执行失败。原因: spawn pnpm ENOENT`

### 根因

- 问题**不是** Atlas 业务逻辑/路由
- 问题**是** launchd 环境 PATH 贫瘠，子进程 spawn 时找不到 pnpm
- 修复方向：oc-bind Atlas executor 不依赖 PATH，使用显式 pnpm 路径（PNPM_BIN 或固定候选）

---

## 2. Gate 输出原文

### Pre-change

```
=== Preflight PASS ===
Latest ledger: PCK-BOOTSTRAP-000

RG-001 PASS: Version/identity evidence found in runtime
RG-ATLAS-001 PASS: No forbidden radar strings
RG-ATLAS-002: gateway logs exist but no fingerprint yet (invoke /atlas help to populate)
RG-ATLAS-002 PASS: build fingerprint format OK: build: 4359a0d PCK-ATLAS-002 oc-bind
RG-ATLAS-002 PASS: build fingerprint present and format valid
=== Regress PASS ===
```

### Post-change

```
=== Preflight PASS ===
Latest ledger: PCK-BOOTSTRAP-000

RG-001 PASS: Version/identity evidence found in runtime
RG-ATLAS-001 PASS: No forbidden radar strings
RG-ATLAS-002: gateway logs exist but no fingerprint yet (invoke /atlas help to populate)
RG-ATLAS-002 PASS: build fingerprint format OK: build: 4359a0d PCK-ATLAS-003 oc-bind
RG-ATLAS-002 PASS: build fingerprint present and format valid
RG-ATLAS-003 PASS: No forbidden radar strings
A) Testing with PNPM_BIN=/opt/homebrew/bin/pnpm...
A) PASS: pnpm found via PNPM_BIN
B) Testing with sparse PATH only...
B) PASS: pnpm found via fixed path
RG-ATLAS-003-pnpm-enoent-proof PASS
=== Regress PASS ===

=== Convergence PASS (contract unchanged) ===
```

---

## 3. 修复策略与变更点

### pnpm 解析（atlas-adapter.ts）

1) **resolvePnpmBin()**：严格顺序
   - env.PNPM_BIN 存在且可执行 → 使用
   - 否则固定候选：/opt/homebrew/bin/pnpm → /usr/local/bin/pnpm → /usr/bin/pnpm
   - 都不可用 → 返回 pnpm_missing，含 probe + hint: set PNPM_BIN

2) **spawn**：使用绝对路径 pnpm，argv 固定为 `[pnpm, "-C", root, "run", "atlas:run"]`，shell:false

3) **失败时错误**：包含 pnpm_bin_used、env_path、atlas_root、hint: set PNPM_BIN

### /atlas debug 增强（index.ts）

- PATH（原样，过长截断并标记 truncated）
- pnpm_bin（最终选择的路径；无则 "none"）
- pnpm_probe（探测结果：各候选 exists/missing/not_executable）

### 修改文件列表

| 文件 | 变更 |
|------|------|
| oc-bind/atlas-adapter.ts | resolvePnpmBin()、spawn 绝对路径、错误元数据 |
| oc-bind/index.ts | debug 输出 PATH/pnpm_bin/pnpm_probe；错误信息含 pnpm_bin_used 等；ledger PCK-ATLAS-003 |
| oc-bind/atlas-pnpm-probe.ts | 新增 harness，仅调用 resolvePnpmBin |
| .project-control/00-ledger/PCK-ATLAS-003/* | 新增 ledger |
| .project-control/02-regressions/RG-ATLAS-003-no-radar-strings.sh | 新增，含 ACTION_RADAR |
| .project-control/02-regressions/RG-ATLAS-003-pnpm-enoent-proof.sh | 新增，模拟 launchd PATH |

---

## 4. 本机模拟（RG-ATLAS-003 原始输出）

```
A) Testing with PNPM_BIN=/opt/homebrew/bin/pnpm...
A) PASS: pnpm found via PNPM_BIN
B) Testing with sparse PATH only...
B) PASS: pnpm found via fixed path
RG-ATLAS-003-pnpm-enoent-proof PASS
```

- A) `env -i PATH=/usr/bin:/bin:/usr/sbin:/sbin PNPM_BIN=/opt/homebrew/bin/pnpm` → 无 ENOENT
- B) `env -i PATH=/usr/bin:/bin:/usr/sbin:/sbin` → 固定路径存在则无 ENOENT；否则错误含 "set PNPM_BIN"

---

## 5. 手动 TG 验证步骤与预期

| 操作 | 预期 |
|------|------|
| /atlas debug | ATLAS_* 三项 present；PATH 显示 launchd 值；pnpm_bin 显示 /opt/homebrew/bin/pnpm 或 PNPM_BIN 指定值；含 build fingerprint |
| /atlas today | 不再 spawn pnpm ENOENT；成功返回 dashboardUrl + run_id；cover 不可用时仍给 dashboardUrl |
| NL「发我 atlas 看板 / 今日 atlas / atlas / 看板 / dashboard / situation monitor」 | 与 /atlas today 行为一致 |
| /atlas help | 不包含 radar |

---

## 6. 与上一版本差异

- PCK-ATLAS-002：build fingerprint + /atlas debug（env presence）
- PCK-ATLAS-003：pnpm 绝对路径解析；debug 增加 PATH、pnpm_bin、pnpm_probe；错误信息可操作化
- 未破坏：Atlas 独立性、无 radar、contract.snapshot.md 未变

---

## Failure Classification

failure_mode: OK
root_cause: 
recommended_fix:
