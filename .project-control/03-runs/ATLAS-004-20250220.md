# Run Journal — ATLAS-004 (PCK-ATLAS-004)

**Task:** Shebang-Proof 执行模型 — node 直接执行 pnpm.cjs

**Timestamp:** 2025-02-20

---

## 1. 旧错误输出（spawn pnpm ENOENT）

```
❌ Atlas 执行失败。

**原因:** spawn pnpm ENOENT

pnpm_bin_used=/opt/homebrew/bin/pnpm
env_path=/usr/bin:/bin:/usr/sbin:/sbin
atlas_root=/path/to/atlas-radar

**下一步:** 若 pnpm 不可用，设置 PNPM_BIN=...
```

*根因：shebang `#!/usr/bin/env node` 在 launchd 下解释器解析失败。*

---

## 2. 新 debug 输出（/atlas debug 预期）

```
build: <sha> PCK-ATLAS-004 oc-bind
plugin_dir: oc-bind
ATLAS_ROOT: present
ATLAS_DASHBOARD_URL_BASE: present
ATLAS_COVER_URL_BASE: present
PATH: /usr/bin:/bin:...[truncated]
node_bin: /opt/homebrew/bin/node
pnpm_js: /opt/homebrew/lib/node_modules/pnpm/bin/pnpm.cjs
node_probe: /opt/homebrew/bin/node=exists
pnpm_js_probe: /opt/homebrew/lib/node_modules/pnpm/bin/pnpm.cjs=exists
```

---

## 3. 模拟 launchd 测试输出

### atlas-node-probe.cjs

```
$ env -i PATH=/usr/bin:/bin:/usr/sbin:/sbin NODE_BIN=/opt/homebrew/bin/node PNPM_JS=/opt/homebrew/lib/node_modules/pnpm/bin/pnpm.cjs node tools/atlas-node-probe.cjs

node_bin: /opt/homebrew/bin/node
pnpm_js: /opt/homebrew/lib/node_modules/pnpm/bin/pnpm.cjs
node_probe: {"/opt/homebrew/bin/node":"exists"}
pnpm_js_probe: {"/opt/homebrew/lib/node_modules/pnpm/bin/pnpm.cjs":"exists"}
```

### atlas-node-spawn-test.cjs

```
$ node tools/atlas-node-spawn-test.cjs

atlas-node-spawn-test PASS: pnpm -v exit 0
```

### RG-ATLAS-004-shebang-proof

```
A) Testing probe with NODE_BIN+PNPM_JS...
A) PASS: probe found node and pnpm.cjs
B) Testing spawn node pnpm.cjs -v...
B) PASS: spawn succeeded
RG-ATLAS-004-shebang-proof PASS
```

---

## 4. Gate 输出

```
=== Preflight PASS ===
Latest ledger: PCK-BOOTSTRAP-000

RG-001 PASS: Version/identity evidence found in runtime
RG-ATLAS-001 PASS: No forbidden radar strings
RG-ATLAS-002: gateway logs exist but no fingerprint yet (invoke /atlas help to populate)
RG-ATLAS-002 PASS: build fingerprint format OK: build: 4359a0d PCK-ATLAS-004 oc-bind
RG-ATLAS-002 PASS: build fingerprint present and format valid
RG-ATLAS-003 PASS: No forbidden radar strings
RG-ATLAS-004 PASS: No forbidden radar strings
A) Testing probe with NODE_BIN+PNPM_JS...
A) PASS: probe found node and pnpm.cjs
B) Testing spawn node pnpm.cjs -v...
B) PASS: spawn succeeded
RG-ATLAS-004-shebang-proof PASS
=== Regress PASS ===

=== Convergence PASS (contract unchanged) ===
```

---

## 5. TG /atlas today 成功输出（预期）

- 不再出现 spawn pnpm ENOENT
- 返回 dashboardUrl + run_id
- 若 cover 不可用：仍返回 dashboardUrl + 明确提示
- gateway.log 中：`action=ATLAS_TODAY ok=true`

*需在真实 TG 环境验证。*

---

## 6. 变更摘要

| 文件 | 变更 |
|------|------|
| atlas-adapter.ts | resolveNodeBin(), resolvePnpmJs(), spawn(nodeBin, [pnpmJs, "-C", root, "run", "atlas:run"]) |
| index.ts | debug: node_bin, pnpm_js, node_probe, pnpm_js_probe；错误: node_bin_used, pnpm_js_used |
| tools/atlas-node-probe.cjs | 新增 harness |
| tools/atlas-node-spawn-test.cjs | 新增 spawn 测试 |
| RG-ATLAS-004-no-radar-strings.sh | 新增 |
| RG-ATLAS-004-shebang-proof.sh | 新增 |
| atlas-pnpm-probe.ts | 删除（已由 atlas-node-probe.cjs 替代） |
| RG-ATLAS-003-pnpm-enoent-proof.sh | 删除（已由 RG-ATLAS-004-shebang-proof 替代） |

---

## Failure Classification

failure_mode: OK
root_cause: 
recommended_fix:
